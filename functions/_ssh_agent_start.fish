function _ssh_agent_start --description "Start a new ssh agent"
    set -l lock_file "$SSH_ENV.lock"

    # Race Condition Handling:
    # We use a directory lock (mkdir is atomic) to ensure only one shell starts the agent.
    # If we fail to get the lock, we wait for the other process to finish.
    if not mkdir "$lock_file" 2>/dev/null
        for i in (seq 1 20) # Wait up to 2 seconds
            if test -f "$SSH_ENV"
                source "$SSH_ENV" >/dev/null 2>&1
                ssh-add -l >/dev/null 2>&1
                if test $status -eq 0; or test $status -eq 1
                    return 0
                end
            end
            sleep 0.1
        end
        # Timeout: Assume stale lock, remove it and proceed to start a new agent.
        rmdir "$lock_file" 2>/dev/null
    else
        # Lock acquired.
        # Double-check: Another process might have finished just before we got the lock.
        if test -f "$SSH_ENV"
            source "$SSH_ENV" >/dev/null 2>&1
            ssh-add -l >/dev/null 2>&1
            if test $status -eq 0; or test $status -eq 1
                rmdir "$lock_file"
                return 0
            end
        end
    end

    # Start the agent
    # We use the -c flag to generate csh-style output of the form:
    # setenv SSH_AUTH_SOCK ...
    # This output is then converted to fish-style output.
    set -l ssh_output (ssh-agent -c)
    set -l filtered_output

    for line in $ssh_output
        if string match --quiet --regex '^echo' -- $line
            continue
        end
        set -l transformed (string replace 'setenv' 'set -gx' -- $line)
        set transformed (string replace --regex ';(\s*)$' '' -- $transformed)
        set --append filtered_output $transformed
    end

    if test (count $filtered_output) -eq 0
        rmdir "$lock_file"
        echo "Failed to start ssh-agent"
        return 1
    end

    set --prepend filtered_output "# Generated by fish-ssh-agent"
    printf "%s\n" $filtered_output >"$SSH_ENV"
    chmod 600 "$SSH_ENV"
    source "$SSH_ENV"
    rmdir "$lock_file"
    echo "Started new SSH agent. Run 'ssh-add' to add keys."
end
